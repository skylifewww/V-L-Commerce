name: Deploy to Fly

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  APP_NAME: commerce-buygo
  DOCKER_CONTEXT: .

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency: deploy-group
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for cross-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Compute image tag
        id: prep
        run: echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Authenticate to Fly and registry
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl auth docker

      - name: Build and push image to Fly registry
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t registry.fly.io/${APP_NAME}:${{ steps.prep.outputs.IMAGE_TAG }} \
            --push \
            ${DOCKER_CONTEXT}

      - name: Deploy pushed image
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --app ${APP_NAME} \
            --image registry.fly.io/${APP_NAME}:${{ steps.prep.outputs.IMAGE_TAG }} \
            --now

      - name: Notify Slack (success)
        if: ${{ success() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload='{"text":"✅ Deploy success: '${APP_NAME}' @ $GITHUB_SHA\n'$GITHUB_RUN_URL'"}'
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

      - name: Notify Slack (failure)
        if: ${{ failure() && env.SLACK_WEBHOOK_URL != '' }}
        env:
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload='{"text":"❌ Deploy failed: '${APP_NAME}' @ $GITHUB_SHA\n'$GITHUB_RUN_URL'"}'
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

      - name: Notify Telegram (success)
        if: ${{ success() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' }}
        env:
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="✅ Deploy success: ${APP_NAME} @ ${GITHUB_SHA}%0A${GITHUB_RUN_URL}"
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (failure)
        if: ${{ failure() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' }}
        env:
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="❌ Deploy failed: ${APP_NAME} @ ${GITHUB_SHA}%0A${GITHUB_RUN_URL}"
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="$TEXT" \
            -d parse_mode="Markdown"
