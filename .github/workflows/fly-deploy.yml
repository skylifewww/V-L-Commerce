name: Deploy to Fly

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  APP_NAME: commerce-buygo
  DOCKER_CONTEXT: .

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency: deploy-group
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for cross-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1.5

      - name: Compute image tag
        id: prep
        run: echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Authenticate to Fly and registry
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl auth docker

      - name: Build and push image to Fly registry
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t registry.fly.io/${APP_NAME}:${{ steps.prep.outputs.IMAGE_TAG }} \
            --push \
            ${DOCKER_CONTEXT}

      - name: Deploy pushed image
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --app ${APP_NAME} \
            --image registry.fly.io/${APP_NAME}:${{ steps.prep.outputs.IMAGE_TAG }} \
            --now
